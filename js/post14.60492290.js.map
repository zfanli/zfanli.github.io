{"version":3,"sources":["webpack:///./src/pages/2019-01-14-oracle-reproduce.md"],"names":["module","exports","attributes","title","subtitle","date","tags","body","frontmatter"],"mappings":"yFAAAA,EAAAC,QAAA,CAAkBC,WAAA,CAAcC,MAAA,gCAAAC,SAAA,4CAAAC,KAAA,2BAAAC,KAAA,sCAA6KC,KAAA,kwtBAA6xtBC,YAAA","file":"js/post14.60492290.js","sourcesContent":["module.exports = {\"attributes\":{\"title\":\"Oracle æ•°æ®åº“ SQL è°ƒä¼˜ç¬”è®° 2 - é‡ç°ä¸å®è·µ\",\"subtitle\":\"ä½¿ç”¨ Docker å¿«é€Ÿæ­å»ºä¸€ä¸ª Oracle æ•°æ®åº“æµ‹è¯•ç¯å¢ƒï¼Œæ¥åšä¸€æ¬¡è°ƒä¼˜å®æˆ˜ï¼\",\"date\":\"2019-01-14T02:15:00.000Z\",\"tags\":[\"Oracle\",\"SQL\",\"Database\",\"Docker\"]},\"body\":\"\\nä¸Šç¯‡æ–‡ç« æœ€åç•™äº†ä¸€ä¸ªæ¸…é™¤ç¼“å­˜çš„ Tipsï¼Œè¿™ç¯‡æ–‡ç« å°†ä¼šç”¨åˆ°ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œå†è´´ä¸€æ¬¡ã€‚\\n\\n```sql\\nalter system flush buffer_cache;\\nalter system flush shared_pool;\\n```\\n\\n---\\n\\n### å†™åœ¨å‰é¢\\n\\nç”¨ä¸¤ç¯‡æ–‡ç« æ¥å¯¹æœ€è¿‘é¡¹ç›®ä¸­é‡åˆ°çš„ SQL æ€§èƒ½é—®é¢˜åšä¸€ä¸ªç¬”è®°å’Œæ€»ç»“ã€‚\\n\\nä¸Šç¯‡æ–‡ç« ä¸­æˆ‘ä»¬æè¿°äº†ä¼˜åŒ–çš„æ€è·¯ï¼Œå¹¶ä¸”ç»“åˆæ¡ˆä¾‹ä»‹ç»äº†å‡ ä¸ªä¸»è¦é—®é¢˜çš„ä¼˜åŒ–æ–¹æ¡ˆã€‚è¿™ç¯‡æ–‡ç« å°†æ­å»ºä¸€ä¸ªæµ‹è¯•ç¯å¢ƒæ¥å¯¹å…¶ä¸­çš„ä¸€äº›æ¡ˆä¾‹è¿›è¡Œé‡ç°ï¼Œå¹¶å¥—ç”¨è§£å†³æ–¹æ¡ˆæ¥åšä¸€ä¸ªå®æˆ˜ã€‚\\n\\n- [Oracle æ•°æ®åº“ SQL è°ƒä¼˜ç¬”è®° 1 - æ€è·¯å’Œæ–¹æ¡ˆ](#/post/Oracle%20æ•°æ®åº“%20SQL%20è°ƒä¼˜ç¬”è®°%201%20-%20æ€è·¯å’Œæ–¹æ¡ˆ)\\n- Oracle æ•°æ®åº“ SQL è°ƒä¼˜ç¬”è®° 2 - é‡ç°ä¸å®è·µï¼ˆæœ¬æ–‡ï¼‰\\n\\n### å‡†å¤‡\\n\\nè¿™æ˜¯å‡†å¤‡éƒ¨åˆ†ã€‚\\n\\n#### æ­å»ºæµ‹è¯•ç¯å¢ƒ\\n\\n> âš ï¸ å¦‚æœä½ çš„ç¯å¢ƒå·²ç»å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥è·³è¿‡è¿™ä¸€æ­¥ã€‚\\n\\næ–¹ä¾¿èµ·è§ï¼Œç›´æ¥ç”¨ Docker æ¥å¿«é€Ÿæ­å»ºä¸€ä¸ª Oracle æ•°æ®åº“ç¯å¢ƒã€‚å¦‚æœä½ è¿˜æ²¡æœ‰ Docker ç¯å¢ƒï¼Œé‚£ä¹ˆé¦–å…ˆä» [è¿™é‡Œ](https://www.docker.com/get-started) ä¸‹è½½å¹¶å®‰è£… Dockerã€‚\\n\\nåœ¨å‘½ä»¤è¡Œç¡®è®¤ä¸€ä¸‹ Docker ç‰ˆæœ¬ï¼Œç¡®è®¤æ˜¯å¦å®‰è£…æˆåŠŸã€‚\\n\\n```bash\\n$ docker --version\\nDocker version 18.09.0, build 4d60db4\\n```\\n\\né¦–å…ˆç™»é™† Docker Hubï¼Œä½¿ç”¨ä¸‹è½½æ—¶æ³¨å†Œçš„è´¦æˆ·ã€‚æ•²ä»¥ä¸‹å‘½ä»¤ç„¶åæ ¹æ®æç¤ºæ¥ç™»é™†å³å¯ã€‚\\n\\n```bash\\n$ docker login\\n```\\n\\nç™»é™†å®Œæˆåï¼Œå¯ä»¥æ‹‰å– Oracle æ•°æ®åº“ç¯å¢ƒäº†ã€‚ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼Œæ‹‰å–ä¸€ä¸ªåˆ«äººå·²ç»é…ç½®å¥½çš„ Oracle 12c ç‰ˆæœ¬çš„æ•°æ®åº“ã€‚è¿™ä¸ªç‰ˆæœ¬ä¸æ˜¯ä¼ä¸šç‰ˆï¼Œä¸èƒ½åšè¡¨åˆ†åŒºï¼Œä¸è¿‡è¿™æ¬¡æˆ‘ä»¬ä¸å°è¯•è¡¨åˆ†åŒºå†…å®¹ï¼Œæ‰€ä»¥æ ‡å‡†ç‰ˆè¶³å¤Ÿäº†ã€‚\\n\\n```bash\\n$ docker pull sath89/oracle-12c\\n```\\n\\næ–‡ä»¶æœ‰ç‚¹å¤§ï¼Œç­‰å®‰è£…å®Œæˆåï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥å¯åŠ¨ Oracle æ•°æ®åº“ã€‚\\n\\n```bash\\n$ docker run -d -e WEB_CONSOLE=false -p 1521:1521 sath89/oracle-12c\\n```\\n\\nç¨ç­‰ç‰‡åˆ»ï¼Œæ§åˆ¶å°ä¼šè¾“å‡ºä¸€é•¿ä¸²çš„ IDï¼ŒOracle æ•°æ®åº“å·²ç»å¯åŠ¨æˆåŠŸäº†ï¼Œå¹¶ä¸”æ˜ å°„åˆ°æœ¬åœ° `1521` ç«¯å£ä¸Šäº†ï¼Œè¿™æ—¶å¯ä»¥ä½¿ç”¨ä»»ä½•ä½ å–œæ¬¢çš„å·¥å…·è¿æ¥æ•°æ®åº“è¿›è¡Œåé¢çš„æ“ä½œäº†ã€‚è¿æ¥æ•°æ®åº“æ—¶ä½¿ç”¨ä¸‹é¢çš„å‚æ•°ã€‚\\n\\n```yaml\\nhostname: localhost\\nport: 1521\\nsid: xe\\nservice name: xe\\nusername: system\\npassword: oracle\\n```\\n\\nä¹Ÿå¯ä»¥ç›´æ¥è¿›å…¥è™šæ‹Ÿæœºç¯å¢ƒä¸­ä½¿ç”¨ SQL\\\\*Plusã€‚\\n\\n```bash\\n# é¦–å…ˆæ‹¿åˆ° Container çš„ ID\\n$ docker ps\\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                              NAMES\\n2a00bcc34a0f        sath89/oracle-12c   \\\"/entrypoint.sh \\\"   8 minutes ago       Up 8 minutes        0.0.0.0:1521->1521/tcp, 8080/tcp   recursing_saha\\n# ç”¨æ‹¿åˆ°çš„ ID è¿›å…¥æ§åˆ¶å°\\n$ docker exec -it 2a00bcc34a0f /bin/bash\\n# å¯ä»¥çœ‹åˆ°å‰ç¼€çš„å˜æ¢ï¼Œç°åœ¨å·²ç»å¤„äºè™šæ‹Ÿæœºä¸­çš„æ§åˆ¶å°\\n# ç„¶åï¼Œåˆ‡æ¢åˆ° oracle ç”¨æˆ·\\nroot@2a00bcc34a0f:/\\\\# su oracle\\n# è¿›å…¥ Oracle å®‰è£…ç›®å½•\\noracle@2a00bcc34a0f:/$ cd $ORACLE_HOME\\n# å¯åŠ¨ sqlplus\\noracle@2a00bcc34a0f:/u01/app/oracle/product/12.1.0/xe$ bin/sqlplus / as sysdba\\n\\nSQL*Plus: Release 12.1.0.2.0 Production on Tue Jan 8 09:51:44 2019\\n\\nCopyright (c) 1982, 2014, Oracle.  All rights reserved.\\n\\n\\nConnected to:\\nOracle Database 12c Standard Edition Release 12.1.0.2.0 - 64bit Production\\n\\nSQL> select 1 from dual;\\n\\n   1\\n----------\\n   1\\n\\nSQL>\\n```\\n\\nè¦å…³é—­ Oracle æ•°æ®åº“ï¼Œè¾“å…¥ä¸‹é¢çš„å‘½ä»¤ã€‚å¦‚æœä¸çŸ¥é“ Container IDï¼Œå¯ä»¥ä½¿ç”¨ `docker ps` å‘½ä»¤æŸ¥è¯¢ã€‚\\n\\n```bash\\n$ docker container stop [container id]\\n```\\n\\nå‚è€ƒæ–‡æ¡£ï¼š\\n\\n- [Docker Documentation](https://docs.docker.com/)\\n- [Docker Hub - sath89/oracle-12c](https://hub.docker.com/r/sath89/oracle-12c)\\n\\n#### å‡†å¤‡æµ‹è¯•æ•°æ®\\n\\næˆ‘ä»¬è®¾è®¡ä¸€ä¸ªæ¸¸æˆåœºæ™¯ã€‚å‡è®¾æœ‰ä¸¤å¼ è¡¨ï¼Œä¸€ä¸ªå«åš `characters`ï¼Œç”¨æ¥å‚¨å­˜æ‰€æœ‰çš„è§’è‰²ä¿¡æ¯ï¼Œè®©æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥åˆ›å»ºã€‚\\n\\n```sql\\ncreate table characters_temp as select\\n  -- è§’è‰² IDï¼ˆ1-500000ï¼‰é€’å¢ï¼Œå·¦è¾¹è¡¥é›¶åˆ° 8 ä½\\n  lpad(level, 8, '0') as character_id,\\n  -- ç©å®¶ IDï¼Œå¯é‡å¤ï¼ˆ1-500000ï¼‰ä¸­éšæœº\\n  floor(dbms_random.value(1, 500000)) as gamer_id,\\n  -- è§’è‰²æ€§åˆ«ï¼Œ0: Femaleï¼Œ1: Male\\n  floor(dbms_random.value(0, 2)) as character_gender,\\n  -- è§’è‰²ç­‰çº§ï¼ˆ1-100ï¼‰ä¸­éšæœº\\n  floor(dbms_random.value(1, 100)) as character_level,\\n  -- è§’è‰²æŒæœ‰çš„é‡‘å¸ï¼ˆ1-10000ï¼‰ä¸­éšæœº\\n  floor(dbms_random.value(1, 10000)) as character_coin,\\n  -- åˆ›å»ºæ—¶é—´\\n  current_timestamp as create_date,\\n  -- è§’è‰²åç§°\\n  'NAME_' || level as character_name\\nfrom dual connect by level <= 500000;\\n```\\n\\næ‰§è¡Œä¸Šé¢çš„è¯­å¥ï¼Œå¯ä»¥å¾—åˆ°ä¸€å¼  50 ä¸‡æ•°æ®çš„ä¸´æ—¶è§’è‰²è¡¨ã€‚ä¸è¿‡ç›®å‰å­—æ®µæ¯”è¾ƒå°‘ï¼ŒçœŸå®åœºæ™¯è‚¯å®šä¸æ­¢è¿™äº›å­—æ®µï¼Œæˆ‘ä»¬åˆ©ç”¨ç¬›å¡å°”ç§¯æ¥ä¸°å¯Œæµ‹è¯•æ•°æ®ï¼Œè®©ä¸¤å¼ è¡¨ç›¸ä¹˜ï¼Œæ‰©å……ä¸€ä¸‹å…¶ä»–å­—æ®µä½œä¸ºèƒŒæ™¯æ•°æ®ã€‚è¿™é‡Œçœ‹ä¸Šå» `all_indexes` è¡¨å­—æ®µæ¯”è¾ƒå¤šï¼Œå°±ç”¨å®ƒæ¥æ‰©å……æ•°æ®äº†ã€‚\\n\\n```sql\\ncreate table characters as select\\n  t.*, d.*\\nfrom\\n  characters_temp t,\\n  (select * from all_indexes\\n  where rownum = 1) d;\\n```\\n\\næ‰§è¡Œå®Œä¸Šé¢çš„è¯­å¥ï¼Œæˆ‘ä»¬çš„æ•°æ®é‡è™½ç„¶ä¸å˜ï¼Œä½†æ˜¯å­—æ®µæ•°é‡å¢åŠ äº†ä¸å°‘ã€‚æˆ‘ä»¬å…ˆç»™è¿™å¼ è¡¨åŠ ä¸Šä¸»é”®ã€‚\\n\\n```sql\\nalter table characters\\n  modify character_id varchar2(8) not null;\\nalter table characters\\n  add constraint characters_pk primary key (character_id);\\n```\\n\\nåˆ°è¿™é‡Œè§’è‰²è¡¨çš„æ•°æ®å°±å‡†å¤‡å®Œæˆäº†ï¼Œæ­¤æ—¶è¡¨ç»“æ„åº”è¯¥æ˜¯è¿™æ ·çš„ã€‚\\n\\n```sql\\nSQL> desc characters;\\n Name                  Null?    Type\\n --------------------- -------- ----------------------------\\n CHARACTER_ID          NOT NULL VARCHAR2(8)\\n GAMER_ID                       NUMBER\\n CHARACTER_GENDER               NUMBER\\n CHARACTER_LEVEL                NUMBER\\n CHARACTER_COIN                 NUMBER\\n CREATE_DATE                    TIMESTAMP(6) WITH TIME ZONE\\n CHARACTER_NAME                 VARCHAR2(45)\\n-- ä»¥ä¸Šæ˜¯æˆ‘ä»¬ä¼šç”¨åˆ°çš„å­—æ®µï¼Œä»¥ä¸‹æ˜¯èƒŒæ™¯æ•°æ®çš„å­—æ®µï¼Œå…± 60 ä¸ªå­—æ®µ\\n OWNER                 NOT NULL VARCHAR2(128)\\n INDEX_NAME            NOT NULL VARCHAR2(128)\\n ...\\n ...\\n ...\\n ORPHANED_ENTRIES               VARCHAR2(3)\\n INDEXING                       VARCHAR2(7)\\n```\\n\\nå¹¶ä¸”å­˜åœ¨ä¸€ä¸ªä¸»é”®ç´¢å¼•ã€‚\\n\\n```sql\\nSQL> select index_name from user_indexes\\nwhere table_name = upper('characters');\\n\\nINDEX_NAME\\n---------------\\nCHARACTERS_PK\\n```\\n\\nå¦ä¸€å¼ è¡¨ `items` ç”¨æ¥å‚¨å­˜è§’è‰²çš„æ‰€æŒç‰©å“ä¿¡æ¯ï¼Œæˆ‘ä»¬å®šä¹‰æ¯ä¸ªè§’è‰²æœ‰ 10 ä¸ªç‰©å“æ ï¼Œæ¯ä¸ªç‰©å“æ å¯ä»¥æ”¾ä¸€ç§ç‰©å“ï¼Œæ•°é‡åœ¨ 1 å’Œ 99 ä¹‹é—´ï¼Œè®¾å®šç±»ä¼¼ MineCraftã€‚\\n\\n```sql\\ncreate table items_temp as select\\n  -- ç‰©å“é¡ºåºï¼ˆ1-10ï¼‰\\n  i.item_order as item_order,\\n  -- è§’è‰² ID\\n  c.character_id as character_id,\\n  -- ç‰©å“ IDï¼ˆ1-50ï¼‰ä¸­éšæœº\\n  floor(dbms_random.value(1, 51)) as item_id,\\n  -- ç‰©å“æ•°é‡ï¼ˆ1-99ï¼‰ä¸­éšæœº\\n  floor(dbms_random.value(1, 100)) as item_num,\\n  -- ç‰©å“å¯ç”¨ flagï¼ˆ0-1ï¼‰ä¸­éšæœº\\n  floor(dbms_random.value(0, 2)) as enable_flag,\\n  -- æ›´æ–°æ—¶é—´\\n  current_timestamp as last_update_time,\\n  -- ç‰©å“æè¿°\\n  'DESCRIPTION_' || current_timestamp as item_description\\nfrom\\n  characters c,\\n  (select level as item_order\\n    from dual connect by level <= 10) i;\\n```\\n\\nä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œç‰©å“è¡¨å°†ç»™æ¯ä¸ªè§’è‰²éƒ½åˆ›å»º 10 æ¡è®°å½•ï¼Œç”¨æ¥åˆ†åˆ«å‚¨å­˜æ¯ä¸ªç‰©å“æ ¼å­çš„ä¿¡æ¯ï¼Œè€Œå¯¹äºç‰©å“æ ¼å­ä¸­æ˜¯å¦å­˜åœ¨ç‰©å“ï¼Œåˆ™ä½¿ç”¨ `enable_flag` æ¥æ§åˆ¶ã€‚æ‰§è¡Œè¿™æ¡è¯­å¥ï¼Œç¨ç­‰ç‰‡åˆ»ï¼Œå¯ä»¥å¾—åˆ°äº†ä¸€å¼  500 ä¸‡æ•°æ®çš„æµ‹è¯•è¡¨ã€‚\\n\\nä¾ç…§ä¹‹å‰çš„æ–¹æ³•ï¼Œå°†ç‰©å“è¡¨ä¹Ÿæ·»åŠ ä¸Šä¸€äº›å…¶ä»–å­—æ®µæ¥ä¸°å¯Œæ•°æ®ã€‚\\n\\n```sql\\ncreate table items as select\\n  i.*, d.*\\nfrom\\n  items_temp i,\\n  (select * from all_indexes\\n  where rownum = 1) d;\\n```\\n\\nåŒæ ·çš„ï¼Œç»™ç‰©å“è¡¨åŠ ä¸Šä¸»é”®ã€‚ç‰©å“è¡¨ä½¿ç”¨è§’è‰² ID + ç‰©å“é¡ºåºå­—æ®µä½œä¸ºè”åˆä¸»é”®ã€‚\\n\\n```sql\\nalter table items\\n  modify item_order number not null;\\nalter table items\\n  add constraint items_pk primary key (character_id, item_order);\\n```\\n\\nç‰©å“è¡¨çš„è¡¨ç»“æ„åº”è¯¥æ˜¯è¿™æ ·çš„ã€‚\\n\\n```sql\\nSQL> desc items;\\n Name                   Null?    Type\\n --------------------- -------- ----------------------------\\n ITEM_ORDER            NOT NULL NUMBER\\n CHARACTER_ID          NOT NULL VARCHAR2(8)\\n ITEM_ID                        NUMBER\\n ITEM_NUM                       NUMBER\\n ENABLE_FLAG                    NUMBER\\n LAST_UPDATE_TIME               TIMESTAMP(6) WITH TIME ZONE\\n ITEM_DESCRIPTION               VARCHAR2(85)\\n-- ä»¥ä¸Šæ˜¯æˆ‘ä»¬ä¼šç”¨åˆ°çš„å­—æ®µï¼Œä»¥ä¸‹æ˜¯èƒŒæ™¯æ•°æ®çš„å­—æ®µï¼Œå…± 60 ä¸ªå­—æ®µ\\n OWNER                 NOT NULL VARCHAR2(128)\\n INDEX_NAME            NOT NULL VARCHAR2(128)\\n ...\\n ...\\n ...\\n ORPHANED_ENTRIES               VARCHAR2(3)\\n INDEXING                       VARCHAR2(7)\\n```\\n\\nè¿˜æœ‰ä¸€ä¸ªä¸»é”®ç´¢å¼•ã€‚\\n\\n```sql\\nSQL> select index_name from user_indexes\\nwhere table_name = upper('items');\\n\\nINDEX_NAME\\n-----------\\nITEMS_PK\\n```\\n\\næµ‹è¯•æ•°æ®çš„å‡†å¤‡å°±å®Œæˆäº†ã€‚\\n\\n#### å¼€å§‹å®æˆ˜ä¹‹å‰\\n\\nå‡†å¤‡å·²ç»å°±ç»ªï¼Œä¸è¿‡åœ¨è¿›å…¥å®æˆ˜ä¹‹å‰ï¼Œè¿˜æœ‰ä¸€äº› Tips å¯ä»¥å¸®åŠ©æˆ‘ä»¬è¿›å±•çš„æ›´é¡ºåˆ©ã€‚\\n\\n**æ‰“å¼€ `timing` æ˜¾ç¤ºæ‰§è¡Œæ—¶é—´ã€‚**\\n\\n`timing` è®¾ç½®ä¼šæŠŠ SQL æ‰§è¡Œçš„æ—¶é—´è¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œæ–¹ä¾¿æˆ‘ä»¬è¯„ä¼°æ€§èƒ½ï¼Œæ‰€ä»¥ï¼Œä½ ä¸ç”¨å†æè¡¨ç®—æ—¶é—´äº†ã€‚\\n\\n```sql\\nSQL> set timing on;\\nSQL> select 1 from dual;\\n\\n   1\\n----------\\n   1\\n\\nElapsed: 00:00:00.02\\n```\\n\\n**æ‰“å¼€ `autotrace` æ˜¾ç¤ºæ‰§è¡Œè®¡åˆ’ã€‚**\\n\\n`autotrace` è®¾ç½®å¯ä»¥è®©æˆ‘ä»¬æŸ¥çœ‹å½“å‰ SQL çš„çœŸå®æ‰§è¡Œè®¡åˆ’ï¼Œæ¥å¸®åŠ©æˆ‘ä»¬å®šä½æ€§èƒ½é—®é¢˜æ‰€åœ¨ã€‚\\n\\n```sql\\nSQL> set autotrace on;\\nSQL> select 1 from dual;\\n\\n   1\\n----------\\n   1\\n\\nExecution Plan\\n----------------------------------------------------------\\nPlan hash value: 1388734953\\n\\n-----------------------------------------------------------------\\n| Id  | Operation        | Name | Rows  | Cost (%CPU)| Time     |\\n-----------------------------------------------------------------\\n|   0 | SELECT STATEMENT |      |     1 |     2   (0)| 00:00:01 |\\n|   1 |  FAST DUAL       |      |     1 |     2   (0)| 00:00:01 |\\n-----------------------------------------------------------------\\n\\n\\nStatistics\\n----------------------------------------------------------\\n    0  recursive calls\\n    0  db block gets\\n    0  consistent gets\\n    0  physical reads\\n    0  redo size\\n  535  bytes sent via SQL*Net to client\\n  551  bytes received via SQL*Net from client\\n    2  SQL*Net roundtrips to/from client\\n    0  sorts (memory)\\n    0  sorts (disk)\\n    1  rows processed\\n```\\n\\næ‰§è¡Œè®¡åˆ’çš„è§£è¯»å¯ä»¥å‚è€ƒä¸‹é¢çš„èµ„æ–™ï¼Œä½†æ˜¯å®˜æ–¹èµ„æ–™å¾ˆå¤šåœ°æ–¹éƒ½ä¸åœ¨æˆ‘ä»¬çš„å…³æ³¨ç‚¹ä¸Šï¼Œä¸è¿‡å¥½åœ¨ä»”ç»†é˜…è¯»æ‰§è¡Œè®¡åˆ’ä¹Ÿèƒ½æ‚Ÿå‡ºå¾ˆå¤šæœ‰ç”¨çš„ä¿¡æ¯ï¼Œè‡³å°‘èµ°æ²¡èµ°ç´¢å¼•æ˜¯çœ‹ä¸€çœ¼å°±çŸ¥é“çš„ã€‚\\n\\n**è¿›è¡Œè¡¨åˆ†æ**\\n\\nOracle çš„ä¼˜åŒ–å™¨æ ¹æ®è¡¨çš„ç»Ÿè®¡ä¿¡æ¯æ¥é€‰æ‹©æ‰§è¡Œè®¡åˆ’ã€‚\\n\\næœ‰æ—¶æˆ‘ä»¬ä¼šå‘ç°æ‰§è¡Œè®¡åˆ’å¯èƒ½ä¸å¤ªå‡†ç¡®ï¼Œæ¯”å¦‚æ·»åŠ ä¸€ä¸ªç´¢å¼•åï¼ŒæŸ¥çœ‹æ‰§è¡Œè®¡åˆ’å‘ç° cost é™ä½äº†å¾ˆå¤šï¼Œä½†æ˜¯å®é™…æ‰§è¡Œèµ·æ¥å´æ•ˆç‡ä½ä¸‹ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ\\n\\nå¾ˆæœ‰å¯èƒ½æ˜¯å› ä¸ºè¿™å¼ è¡¨æ²¡æœ‰ç»Ÿè®¡ä¿¡æ¯ï¼Œæˆ–è€…ç»Ÿè®¡ä¿¡æ¯è¿‡æ—¶äº†ï¼Œæ­¤æ—¶éœ€è¦å†æ¬¡å¯¹è¡¨è¿›è¡Œåˆ†æï¼Œæ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼Œæ‰èƒ½è®©ä¼˜åŒ–å™¨é€‰æ‹©æœ€åˆé€‚çš„æ‰§è¡Œè®¡åˆ’ã€‚\\n\\næ‰§è¡Œä¸‹é¢çš„è¯­å¥ï¼Œå¯¹ä¸¤å¼ æµ‹è¯•è¡¨è¿›è¡Œåˆ†æã€‚ä¸€èˆ¬å¯¹è¡¨è¿›è¡Œå¤§è§„æ¨¡å¯¹æ•°æ®åˆ é™¤æˆ–è€…æ’å…¥ä¹‹åéœ€è¦é‡æ–°è¿›è¡Œåˆ†æï¼Œæ¥ä¿è¯ä¼˜åŒ–å™¨é€‰æ‹©æ­£ç¡®çš„æ‰§è¡Œè®¡åˆ’ã€‚\\n\\n```sql\\nanalyze table characters compute statistics;\\nanalyze table items compute statistics;\\n```\\n\\n**âš ï¸ ä»…æµ‹è¯•ç¯å¢ƒä¸‹ï¼Œé™ä½æœåŠ¡å™¨å¯ç”¨èµ„æºã€‚**\\n\\nä¸ºäº†æ–¹ä¾¿å†ç°æ€§èƒ½é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥é™åˆ¶ä¸€ä¸‹ Docker å¼•æ“ä½¿ç”¨çš„ CPU èµ„æºï¼Œæ¨¡æ‹Ÿä½é…ç½®ç¯å¢ƒï¼Œå‚è€ƒä¸‹å›¾ã€‚\\n\\n![Docker Configuration](/img/DockerConfiguration.png)\\n\\nå‚è€ƒæ–‡æ¡£ï¼š\\n\\n- [Database SQL Tuning Guide - 7 Reading Execution Plans](https://docs.oracle.com/database/121/TGSQL/tgsql_interp.htm#TGSQL94618)\\n\\n### æ¢ç´¢æµ‹è¯•æ•°æ®\\n\\nç¯å¢ƒæ­å»ºå¥½äº†ï¼Œæ•°æ®ä¹Ÿå‡†å¤‡å¥½äº†ï¼Œå¯ä»¥å¼€å§‹å®æˆ˜äº†ã€‚ä¸è¿‡å…ˆåˆ«æ…Œï¼Œè¿™äº›æ•°æ®éƒ½æ˜¯éšæœºç”Ÿæˆçš„ï¼Œæˆ‘ä»¬ä¸å¦¨å…ˆæ¥æ¢ç´¢ä¸€ä¸‹ï¼Œäº†è§£è¿™äº›æ•°æ®çš„å¤§è‡´æƒ…å†µã€‚\\n\\n> âš ï¸ ç”±äºå¤§éƒ¨åˆ†éƒ½æ˜¯éšæœºæ•°æ®ï¼Œæ‰€ä»¥å¦‚æœä½ è·Ÿç€æˆ‘çš„æ­¥éª¤æ¢ç´¢çš„è¯ï¼Œä½ çš„ç»“æœå¯èƒ½ä¼šå’Œæˆ‘çš„ä¸åŒã€‚ä¸å¦¨æ¥çœ‹çœ‹æˆ‘ä»¬çš„æ•°æ®ä¹‹é—´æœ‰å¤šå¤§çš„å·®åˆ«ï¼Ÿ\\n\\nå…ˆæ¥çœ‹çœ‹æ•°æ®é‡ï¼ŒæŒ‰ç…§ä¹‹å‰çš„ DDL æ¥çœ‹ï¼Œ`characters` è¡¨åº”è¯¥æœ‰ 50 ä¸‡æ•°æ®ã€‚\\n\\n```sql\\nSQL> select count(1) from characters;\\n\\n  COUNT(1)\\n----------\\n    500000\\n\\nElapsed: 00:00:00.35\\n```\\n\\n`items` è¡¨åˆ™æ˜¯ 500 ä¸‡ã€‚\\n\\n```sql\\nSQL> select count(1) from items;\\n\\n  COUNT(1)\\n----------\\n   5000000\\n\\nElapsed: 00:00:00.58\\n```\\n\\nå—¯ï¼Œçœ‹ä¸Šå»æ²¡é—®é¢˜ï¼Œç”±äºå­˜åœ¨ä¸»é”®ï¼Œ`count(1)` å‡½æ•°ä¼šä½¿ç”¨åˆ°ä¸»é”®ç´¢å¼•ï¼Œæ‰€ä»¥é€Ÿåº¦ä¼šå¾ˆå¿«ã€‚ä»æ‰§è¡Œè®¡åˆ’å¯ä»¥çœ‹å‡ºæ¥ã€‚\\n\\n```sql\\nSQL> set autotrace traceonly;\\nSQL> select count(1) from items;\\n\\nElapsed: 00:00:00.18\\n\\nExecution Plan\\n----------------------------------------------------------\\nPlan hash value: 3881446812\\n\\n------------------------------------------------------------------------\\n\\n| Id  | Operation             | Name     | Rows  | Cost (%CPU)| Time    |\\n\\n------------------------------------------------------------------------\\n\\n|   0 | SELECT STATEMENT      |          |     1 |  4185   (1)| 00:00:01|\\n\\n|   1 |  SORT AGGREGATE       |          |     1 |            |         |\\n\\n|   2 |   INDEX FAST FULL SCAN| ITEMS_PK |  4523K|  4185   (1)| 00:00:01|\\n\\n------------------------------------------------------------------------\\n\\n\\nNote\\n-----\\n   - dynamic statistics used: dynamic sampling (level=2)\\n\\n\\nStatistics\\n----------------------------------------------------------\\n    0  recursive calls\\n    0  db block gets\\n15394  consistent gets\\n    0  physical reads\\n    0  redo size\\n  542  bytes sent via SQL*Net to client\\n  551  bytes received via SQL*Net from client\\n    2  SQL*Net roundtrips to/from client\\n    0  sorts (memory)\\n    0  sorts (disk)\\n    1  rows processed\\n```\\n\\nè¯·æ³¨æ„æ‰§è¡Œè®¡åˆ’ä¸­çš„å…³é”®å­— `ITEMS_PK` å’Œ `INDEX FAST FULL SCAN`ï¼Œè¿™è¯´æ˜è¿™æ¡ SQL è¯­å¥ä½¿ç”¨äº†ä¸»é”®ç´¢å¼•ï¼Œå¹¶ä¸”æ‰§è¡Œäº†ç´¢å¼•å¿«é€Ÿå…¨è¡¨æ‰«æã€‚å¦‚æœè¿™é‡Œæ²¡æœ‰ä¸»é”®ä¼šå¦‚ä½•å‘¢ï¼Ÿæˆ‘ä»¬å°è¯•ä¸€ä¸‹å…ˆåˆ é™¤ä¸»é”®ï¼Œç„¶åå†æ‰§è¡Œä¸€æ¬¡ä¹‹å‰çš„è¯­å¥ã€‚\\n\\n```sql\\nSQL> alter table items drop constraint items_pk;\\n\\nTable altered.\\n\\nElapsed: 00:00:00.31\\n\\nSQL> select count(1) from items;\\n\\n  COUNT(1)\\n----------\\n   5000000\\n\\nElapsed: 00:00:07.03\\n```\\n\\nå¯ä»¥çœ‹åˆ°æŸ¥è¯¢æ—¶é—´ä»ä¸åˆ° 0.58 ç§’é£™å‡åˆ°äº† 7.03 ç§’ã€‚ä¸»é”®ç´¢å¼•è®©æŸ¥è¯¢é€Ÿåº¦æå‡äº†åå¤šå€ï¼Œå¹¶ä¸”é€šå¸¸æ¥è¯´ï¼Œæ•°æ®äº†è¶Šå¤§çš„æƒ…å†µä¸‹ï¼Œæå‡çš„è¶Šæ˜æ˜¾ã€‚\\n\\næ‰§è¡Œè®¡åˆ’ä¹Ÿä¸åŒï¼Œç”±äºè¿‡äºå†—é•¿ï¼Œæˆ‘å°±ä¸è´´å…·ä½“çš„å†…å®¹äº†ï¼Œæƒ³çœ‹å…·ä½“æ‰§è¡Œè®¡åˆ’å¯ä»¥æœ¬åœ°è·‘ä¸€ä¸‹è¿™æ¡è¯­å¥ã€‚\\n\\nå¦‚åŒä¹‹å‰ä¸€æ ·ï¼Œæˆ‘ä»¬åªéœ€è¦å…³æ³¨å‡ ä¸ªå…³é”®å­—å°±è¶³å¤Ÿäº†ã€‚æ²¡æœ‰ä¸»é”®çš„æƒ…å†µä¸‹ `items` èµ°äº†å…¨è¡¨ï¼Œæ‰§è¡Œäº† `TABLE ACCESS FULL` è®¡åˆ’ï¼Œä»å­—é¢ä¸Šç†è§£ï¼Œå°±æ˜¯å…¨è¡¨æ£€ç´¢ã€‚å¹¶ä¸” cost ä¸º 58940ï¼Œè€Œä½¿ç”¨ä¸»é”®çš„æƒ…å†µä¸‹ cost ä¸º 4185ã€‚\\n\\nâš ï¸ å¦‚æœä½ è·Ÿç€æˆ‘çš„æ­¥éª¤æŠŠä¸»é”®åˆ é™¤äº†çš„è¯ï¼Œåˆ«å¿˜äº†ç”¨ä¸‹é¢çš„è¯­å¥å†åŠ å›æ¥ã€‚\\n\\n```sql\\nalter table items\\n  add constraint items_pk primary key (character_id, item_order);\\n```\\n\\nä¸‹ä¸€æ­¥ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¡¨ç©ºé—´æœ‰å¤šå¤§ã€‚\\n\\n```sql\\nSQL> select\\n  segment_name as table_name,\\n  bytes / 1024 / 1024 mb\\nfrom user_segments\\nwhere segment_name = upper('characters')\\nor segment_name = upper('items');\\n\\nTABLE_NAME        MB\\n------------- ------\\nCHARACTERS       151\\nITEMS           1735\\n\\nElapsed: 00:00:00.03\\n```\\n\\næ¥è¿‘ 10 å€å·®è·ï¼Œæ­£å¸¸èŒƒå›´ã€‚\\n\\nåˆ›å»ºè§’è‰²è¡¨çš„æ—¶å€™ï¼Œç©å®¶ ID æ˜¯ä½¿ç”¨ä¸€ä¸ª 1-50,0000 ä¹‹é—´çš„éšæœºæ•°æ¥è¡¨ç¤ºçš„ï¼Œ50 ä¸‡çš„æ•°æ®é‡ä¸‹å¿…å®šä¼šå­˜åœ¨é‡å¤çš„ç©å®¶ IDï¼Œå¯¹äºé‡å¤çš„æ•°æ®æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸ºåŒä¸€ä¸ªç©å®¶æ‰€åˆ›å»ºçš„ä¸åŒè§’è‰²ã€‚æ¥è®©æˆ‘ä»¬çœ‹çœ‹ä¸€å…±æœ‰å¤šå°‘ä¸ªâ€œç‹¬ç«‹â€ç©å®¶ã€‚\\n\\n```sql\\nSQL> select count(1) from (\\n  select distinct gamer_id from characters\\n);\\n\\n  COUNT(1)\\n----------\\n    316260\\n\\nElapsed: 00:00:01.04\\n```\\n\\nä»ç»“æœä¸­æˆ‘ä»¬å¾—åˆ°äº† 2 ä¸ªä¿¡æ¯ã€‚æœ€æ˜æ˜¾çš„ä¿¡æ¯å‘Šè¯‰æˆ‘ä»¬ï¼Œä¸€å…±å­˜åœ¨è¶…è¿‡ 31 ä¸‡çš„ç©å®¶ï¼Œè¿™è¯´æ˜æœ‰æ¥è¿‘ 19 ä¸‡çš„è§’è‰²æ˜¯å±äºå…¶ä»–ç©å®¶ä¸‹é¢çš„é‡å¤è§’è‰²ã€‚å¦ä¸€ä¸ªä¿¡æ¯å°±æ˜¯æ‰§è¡Œé€Ÿåº¦ï¼Œè¶…è¿‡äº† 1 ç§’ã€‚\\n\\nä¸è¿‡è§’è‰²è¡¨è§„æ¨¡è¾ƒå°ï¼Œè¿˜çœ‹ä¸å‡ºæ¥è¿™ä¸ª 1 ç§’çš„å·®è·ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹æ•°æ®è§„æ¨¡å¤§ä¸€ç‚¹çš„ç‰©å“è¡¨ã€‚\\n\\nç‰©å“è¡¨ä¸­æœ‰ä¸€ä¸ª `enable_flag` æ¥æ§åˆ¶è¿™ä¸ªç‰©å“æ˜¯å¦æ˜¯æœ‰æ•ˆçš„ï¼Œæ‰€ä»¥æ¥çœ‹çœ‹æœ‰æ•ˆçš„ç‰©å“ä¸€å…±æœ‰å¤šå°‘å§ã€‚\\n\\n```sql\\nSQL> select count(1) from items where enable_flag = 1;\\n\\n  COUNT(1)\\n----------\\n   2499255\\n\\nElapsed: 00:00:06.33\\n```\\n\\nä¸€ä¸ªéå¸¸è¶‹äºæ¦‚ç‡çš„ç»“æœã€‚æ³¨æ„æŸ¥è¯¢æ—¶é—´æ˜¯ 6 ç§’ï¼Œå¯¹è¿™æ ·ä¸€ä¸ªæŸ¥è¯¢æ¥è¯´ï¼Œè¿™ç®—æ˜¯å¾ˆé•¿çš„æ—¶é—´äº†ã€‚æˆ‘ä»¬å·²ç»å¯ä»¥çœ‹åˆ°ä¸€äº›æ€§èƒ½é—®é¢˜çš„ç«¯å€ªã€‚\\n\\nå†æ¥ä¸€ä¸ªç¨å¾®å¤æ‚ç‚¹çš„ä¾‹å­ï¼Œæ¥çœ‹çœ‹æ¯ä¸ªè§’è‰²å¹³å‡æŒæœ‰çš„æœ‰æ•ˆç‰©å“æ•°é‡ã€‚\\n\\n```sql\\nSQL> select avg(c) from (\\n  select count(1) c from items where enable_flag = 1\\n  group by character_id\\n);\\n\\n    AVG(C)\\n----------\\n5.00361369\\n\\nElapsed: 00:00:09.06\\n```\\n\\næ‰§è¡Œæ—¶é—´ 9 ç§’ï¼\\n\\nçœ‹çœ‹æœ‰å¤šå°‘è§’è‰²æ‹¥æœ‰è¶…è¿‡ 5 ä¸ªæœ‰æ•ˆç‰©å“ã€‚\\n\\n```sql\\nSQL> select count(c) from (\\n  select character_id c from items where enable_flag = 1\\n  group by character_id having count(1) > 5\\n);\\n\\n  COUNT(C)\\n----------\\n    188762\\n\\nElapsed: 00:00:05.29\\n```\\n\\næ¥è¿‘ 19 ä¸‡ï¼Œæ‰§è¡Œäº† 5 ç§’ã€‚\\n\\nçœ‹çœ‹æœ‰å¤šå°‘è§’è‰²ç­‰çº§è¶…è¿‡ 60 çº§ã€‚\\n\\n```sql\\nSQL> select count(1) from characters where character_level > 60;\\n\\n  COUNT(1)\\n----------\\n    196683\\n\\nElapsed: 00:00:01.58\\n```\\n\\næ¥è¿‘ 20 ä¸‡ã€‚è¿™æ¬¡æŸ¥è¯¢çš„æ˜¯è§„æ¨¡å°çš„è§’è‰²è¡¨ï¼Œæ‰§è¡Œæ—¶é—´ 1 ç§’ã€‚\\n\\næˆ‘ä»¬å·²ç»å¤§æ¦‚äº†è§£äº†æ•°æ®çš„æƒ…å†µã€‚\\n\\n- è§’è‰²è¡¨åªæœ‰ 50 ä¸‡æ•°æ®ï¼Œè¡¨ç©ºé—´ä»… 151 Mï¼Œå³ä½¿ä¸ä½¿ç”¨ç´¢å¼•ï¼ŒæŠŠå…¨è¡¨æ•°æ®åŠ è½½åˆ°å†…å­˜å¤„ç†ä¾æ—§å¾ˆå¿«ï¼›\\n- è€Œç‰©å“è¡¨æœ‰ 500 ä¸‡æ•°æ®ï¼Œè¡¨ç©ºé—´æœ‰ 1,735 Mï¼Œä»»ä½•èµ°å…¨è¡¨çš„æ“ä½œéƒ½ä¼šé™ä½ SQL æ‰§è¡Œçš„é€Ÿåº¦ï¼Œè¿™ä¸ªå°ºå¯¸çš„æ•°æ®å·²ç»ä¸å¤ªé€‚åˆå…¨éƒ¨åŠ è½½åˆ°å†…å­˜åå†åšæ“ä½œäº†ã€‚\\n\\n### é‡ç°ç´¢å¼•ä¼˜åŒ–æ¡ˆä¾‹\\n\\nç›®å‰é™¤äº†ä¸»é”®ä»¥å¤–è¿˜æ²¡æœ‰å…¶ä»–ç´¢å¼•ï¼Œåœ¨ä¹‹å‰çš„æ¢ç´¢ä¸­æˆ‘ä»¬å·²ç»å‘ç°äº†ä¸€äº›æ€§èƒ½é—®é¢˜çš„ç«¯å€ªï¼Œç°åœ¨è®©æˆ‘ä»¬è®¾è®¡ä¸€ä¸ªéœ€æ±‚ã€‚\\n\\nè§’è‰²è¡¨ä¸­çš„ `character_coin` å­—æ®µè¡¨ç¤ºè¿™ä¸ªè§’è‰²çš„æŒæœ‰é‡‘å¸æ•°é‡ï¼Œæˆ‘ä»¬å‡è®¾ä¸€ä¸ªéœ€æ±‚ï¼Œå‡ºäºç»Ÿè®¡ç›®çš„ï¼Œç°åœ¨éœ€è¦çŸ¥é“æ‰€æœ‰æŒæœ‰é‡‘å¸æ•°é‡å°‘äº `1,000` çš„è§’è‰²ï¼Œå…¶æ‰€æŒæœ‰çš„ç‰©å“ ID ä¸º `7` çš„ç‰©å“çš„æ•°é‡æ€»å’Œã€‚\\n\\n- **éœ€æ±‚**ï¼š\\n  - ç‰©å“æ•°é‡æ€»å’Œ\\n- **æ¡ä»¶**ï¼š\\n  - è§’è‰²æŒæœ‰é‡‘å¸æ•°é‡å°‘äº `1,000`\\n  - ç‰©å“ ID ä¸º `7`\\n  - ç‰©å“æœ‰æ•ˆ\\n\\nåˆ«å»è€ƒè™‘è¿™ä¸ªéœ€æ±‚æœ‰ä»€ä¹ˆç”¨ã€‚é¦–å…ˆè¿™æ˜¯ç®€å•çš„ `inner join` å…³ç³»ï¼Œæ¡ä»¶ä¹Ÿå¾ˆæ˜ç¡®ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾ˆå¿«å¯ä»¥å¾—å‡ºä¸‹é¢çš„ SQL è¯­å¥ã€‚\\n\\n```sql\\nselect\\n  sum(i.item_num)\\nfrom\\n  items i\\ninner join\\n  characters c\\non\\n  c.character_id = i.character_id\\nwhere\\n      c.character_coin <= 1000\\n  and i.enable_flag = 1\\n  and i.item_id = 7;\\n```\\n\\næŠŠè¿™æ¡è¯­å¥ä¸¢ç»™ Oracle æ‰§è¡Œä¸€ä¸‹è¯•è¯•çœ‹ã€‚\\n\\n```sql\\nSUM(I.ITEM_NUM)\\n---------------\\n         256808\\n\\nElapsed: 00:00:17.30\\n```\\n\\nè¿™ä¸ªç»“æœæ˜¯ç‰©å“è¡¨ `item_num` å­—æ®µçš„æ±‚å’Œçš„å€¼ï¼Œè™½ç„¶ç»“æœæ˜¯ 25 ä¸‡å¤šï¼Œä½†æ˜¯æ¶‰åŠåˆ°çš„æ•°æ®åº”è¯¥ä¸ä¼šå¾ˆå¤šã€‚æœ€ç»ˆè¿™æ¡è¯­å¥æ‰§è¡ŒèŠ±äº† 17.3 ç§’ã€‚\\n\\nè®©æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹æ‰§è¡Œè®¡åˆ’ï¼Œå°è¯•å®šä½ä¸€ä¸‹æ€§èƒ½é—®é¢˜æ‰€åœ¨ã€‚\\n\\n```sql\\nExecution Plan\\n----------------------------------------------------------\\nPlan hash value: 2594570633\\n\\n------------------------------------------------------------------------\\n\\n| Id  | Operation           | Name       | Rows  | Bytes |TempSpc| Cost(%CPU) | Time      |\\n\\n------------------------------------------------------------------------\\n\\n|   0 | SELECT STATEMENT    |            |     1 |    29 |       | 64304   (1)| 00:00:03 |\\n\\n|   1 |  SORT AGGREGATE     |            |     1 |    29 |       |            |          |\\n\\n|*  2 |   HASH JOIN         |            | 49985 |  1415K|  1128K| 64304   (1)| 00:00:03 |\\n\\n|*  3 |    TABLE ACCESS FULL| CHARACTERS | 50010 |   537K|       |  5218   (1)| 00:00:01 |\\n\\n|*  4 |    TABLE ACCESS FULL| ITEMS      | 49985 |   878K|       | 58960   (1)| 00:00:03 |\\n\\n------------------------------------------------------------------------\\n\\n\\nPredicate Information (identified by operation id):\\n---------------------------------------------------\\n\\n   2 - access(\\\"C\\\".\\\"CHARACTER_ID\\\"=\\\"I\\\".\\\"CHARACTER_ID\\\")\\n   3 - filter(\\\"C\\\".\\\"CHARACTER_COIN\\\"<=1000)\\n   4 - filter(\\\"I\\\".\\\"ITEM_ID\\\"=7 AND \\\"I\\\".\\\"ENABLE_FLAG\\\"=1)\\n\\n\\nStatistics\\n----------------------------------------------------------\\n    191  recursive calls\\n      0  db block gets\\n 238878  consistent gets\\n 237747  physical reads\\n      0  redo size\\n    551  bytes sent via SQL*Net to client\\n    551  bytes received via SQL*Net from client\\n      2  SQL*Net roundtrips to/from client\\n      7  sorts (memory)\\n      0  sorts (disk)\\n      1  rows processed\\n```\\n\\næ‰§è¡Œè®¡åˆ’æç¤ºäº†å¾ˆå¤šä¿¡æ¯ï¼Œæˆ‘ä»¬æå–ä¸€äº›å¯¹æˆ‘ä»¬æœ‰ç”¨çš„å‡ºæ¥ã€‚\\n\\n- æ•´ä½“ cost ä¸º `64,304`\\n- `CHARACTERS` è®¿é—®äº†å…¨è¡¨\\n- `ITEMS` è®¿é—®äº†å…¨è¡¨\\n\\n#### å¼€å§‹å°è¯•æ·»åŠ ç´¢å¼•\\n\\nä»æ‰§è¡Œè®¡åˆ’ä¸­å¯ä»¥äº†è§£åˆ°ï¼Œä¸¤å¼ è¡¨éƒ½èµ°äº†å…¨è¡¨æ£€ç´¢æ˜¯çœŸæ­£å½±å“æ‰§è¡Œæ•ˆç‡çš„åŸå› æ‰€åœ¨ï¼Œå¯¹äºè¿™ä¸ªåœºåˆæˆ‘ä»¬ä¸éœ€è¦æ‰€æœ‰çš„æ•°æ®ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨ç´¢å¼•æ¥ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ã€‚\\n\\nå¯¹äºè§’è‰²è¡¨æ¥è¯´ï¼Œä»…ä½¿ç”¨åˆ°ä¸¤ä¸ªå­—æ®µä½œä¸ºæŸ¥è¯¢çš„æ¡ä»¶ï¼Œ`character_id` ä½œä¸ºå…³è”æ¡ä»¶ï¼Œ`character_coin` ä½œä¸ºç­›é€‰æ¡ä»¶ã€‚æ‰€ä»¥å¯¹è¿™ 2 ä¸ªå­—æ®µåˆ›å»ºç´¢å¼•ã€‚\\n\\n```sql\\ncreate index characters_index1 on characters (\\n  character_id,\\n  character_coin\\n);\\n```\\n\\nå¯¹ç‰©å“è¡¨æ¥è¯´ï¼Œæœ‰ 3 ä¸ªå­—æ®µä½œä¸ºæŸ¥è¯¢æ¡ä»¶ï¼Œä¸€ä¸ª `character_id` ä½œä¸ºå…³è”æ¡ä»¶ï¼Œç„¶å `enable_flag` å’Œ `item_id` ä½œä¸ºç­›é€‰æ¡ä»¶ï¼›æ­¤å¤–ï¼Œè¿˜æœ‰ 1 ä¸ªå­—æ®µ `item_num` æœ€ç»ˆè¢«é€‰å‡ºè¿›è¡Œæ±‚å’Œï¼Œæ‰€ä»¥ä¸€å…±éœ€è¦å¯¹ 4 ä¸ªå­—æ®µåˆ›å»ºç´¢å¼•ã€‚\\n\\n```sql\\ncreate index items_index1 on items (\\n  character_id,\\n  enable_flag,\\n  item_id,\\n  item_num\\n);\\n```\\n\\nåˆ›å»ºå¥½ä¸Šé¢çš„ç´¢å¼•ï¼Œæˆ‘ä»¬å‡†å¤‡å†æ‰§è¡Œä¸€æ¬¡ä¹‹å‰çš„è¯­å¥ã€‚ä¸è¿‡å…ˆåˆ«æ€¥ï¼ŒOracle ä¼šè‡ªåŠ¨ä½¿ç”¨ç¼“å­˜ï¼Œæ‰€ä»¥å¦‚æœé‡å¤æŸ¥è¯¢åŒä¸€æ¡ SQLï¼Œé€Ÿåº¦åªä¼šè¶Šæ¥è¶Šå¿«ï¼Œè¿™ä¼šå½±å“æˆ‘ä»¬å°è¯•æ€§èƒ½è°ƒä¼˜çš„ç»“æœï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆæ‰§è¡Œä¸‹é¢ä¸¤æ¡è¯­å¥ï¼Œæ¸…é™¤æ‰ç¼“å­˜çš„å½±å“ã€‚\\n\\n```sql\\nalter system flush buffer_cache;\\nalter system flush shared_pool;\\n```\\n\\nå¥½äº†ï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬é‡æ–°æ‰§è¡Œä¸€æ¬¡ä¹‹å‰çš„è¯­å¥ã€‚\\n\\n```sql\\nSQL> select\\n  sum(i.item_num)\\nfrom\\n  items i\\ninner join\\n  characters c\\non\\n  c.character_id = i.character_id\\nwhere\\n      c.character_coin <= 1000\\n  and i.enable_flag = 1\\n  and i.item_id = 7;\\n\\nSUM(I.ITEM_NUM)\\n---------------\\n         256808\\n\\nElapsed: 00:00:03.29\\n```\\n\\nä» 17.3 ç§’é™ä½åˆ°äº† 3.29 ç§’ï¼Œæ¥è¿‘ 5 å€çš„æ€§èƒ½æå‡ã€‚å†æ¥çœ‹çœ‹æ‰§è¡Œè®¡åˆ’ä¸Šçš„å˜åŒ–ã€‚\\n\\n```sql\\nExecution Plan\\n----------------------------------------------------------\\nPlan hash value: 3200269783\\n\\n------------------------------------------------------------------------\\n\\n| Id  | Operation              | Name              | Rows  | Bytes |TempSpc| Cost (%CPU)| Time     |\\n\\n------------------------------------------------------------------------\\n\\n|   0 | SELECT STATEMENT       |                   |   1   |    29 |       |  6000   (1)| 00:00:01 |\\n\\n|   1 |  SORT AGGREGATE        |                   |   1   |    29 |       |            |          |\\n\\n|*  2 |   HASH JOIN            |                   |  5337 |   151K|  1128K|  6000   (1)| 00:00:01 |\\n\\n|*  3 |    INDEX FAST FULL SCAN| CHARACTERS_INDEX1 | 50010 |   537K|       |   458   (1)| 00:00:01 |\\n\\n|*  4 |    INDEX FAST FULL SCAN| ITEMS_INDEX1      | 49985 |   878K|       |  5416   (1)| 00:00:01 |\\n\\n------------------------------------------------------------------------\\n\\n\\nPredicate Information (identified by operation id):\\n---------------------------------------------------\\n\\n   2 - access(\\\"C\\\".\\\"CHARACTER_ID\\\"=\\\"I\\\".\\\"CHARACTER_ID\\\")\\n   3 - filter(\\\"C\\\".\\\"CHARACTER_COIN\\\"<=1000)\\n   4 - filter(\\\"I\\\".\\\"ITEM_ID\\\"=7 AND \\\"I\\\".\\\"ENABLE_FLAG\\\"=1)\\n\\nNote\\n-----\\n   - dynamic statistics used: dynamic sampling (level=2)\\n\\n\\nStatistics\\n----------------------------------------------------------\\n 1653  recursive calls\\n    0  db block gets\\n27292  consistent gets\\n22596  physical reads\\n    0  redo size\\n  551  bytes sent via SQL*Net to client\\n  551  bytes received via SQL*Net from client\\n    2  SQL*Net roundtrips to/from client\\n  106  sorts (memory)\\n    0  sorts (disk)\\n    1  rows processed\\n```\\n\\nä¾æ—§ä»æ‰§è¡Œè®¡åˆ’ä¸Šæå–æˆ‘ä»¬æ„Ÿå…´è¶£çš„ä¿¡æ¯ã€‚\\n\\n- æ•´ä½“ cost ä¸º `6,000`\\n  - ç›¸è¾ƒä¹‹å‰çš„ `64,304` æœ‰æ˜æ˜¾çš„æ”¹å–„\\n- è§’è‰²è¡¨ä½¿ç”¨äº†æ–°å»ºçš„ `CHARACTERS_INDEX1` ç´¢å¼•\\n  - ç›¸è¾ƒäºå…¨è¡¨æ£€ç´¢ï¼Œå…¨ç´¢å¼•æ£€ç´¢å¯¹æ€§èƒ½æœ‰æ˜æ˜¾çš„æ”¹å–„\\n- ç‰©å“è¡¨ä½¿ç”¨äº†æ–°å»ºçš„ `ITEMS_INDEX1` ç´¢å¼•\\n  - åŒä¸Š\\n\\n#### å°ç»“\\n\\næˆ‘ä»¬å¯¹ç›®å‰é‡åˆ°çš„é—®é¢˜å’Œä½¿ç”¨çš„æ–¹æ³•åšä¸€ä¸ªå°ç»“ã€‚\\n\\n- æ‰§è¡Œè®¡åˆ’å¯ä»¥å¸®åŠ©æˆ‘ä»¬å®šä½é—®é¢˜çš„æ‰€åœ¨\\n  - **å‰ææ˜¯è¡¨è¿›è¡Œè¿‡åˆ†æ**\\n  - å½“æ‰§è¡Œè®¡åˆ’ä¸å‡†ç¡®æ—¶å¯èƒ½æ˜¯ç”±äºç»Ÿè®¡ä¿¡æ¯è¿‡æ—¶\\n  - ä½ éœ€è¦é‡æ–°è¿›è¡Œè¡¨åˆ†æ\\n- åˆ›å»ºç´¢å¼•æ—¶å°½é‡åŒ…å«æŸ¥è¯¢å­—æ®µ\\n  - \\\\*åŒ…å«æ›´å¤šçš„å­—æ®µå°†é€ æˆç´¢å¼•è¡¨æ‰€å ç©ºé—´å¢å¤§\\n  - \\\\*åŒ…å«æ›´å¤šå­—æ®µä¹Ÿå°†é€ æˆç´¢å¼•è¡¨æ£€ç´¢æ—¶é—´å˜é•¿\\n  - åŒ…å«æŸ¥è¯¢å­—æ®µå¯ä»¥é¿å…å›æŸ¥å¼€é”€\\n- åˆ›å»ºç´¢å¼•æ—¶å¦‚æœä»…åŒ…å«æŸ¥è¯¢æ¡ä»¶\\n  - ä½¿ç”¨ `ROWID` å¯¹åŸè¡¨è¿›è¡Œå›æŸ¥è·å–æŸ¥è¯¢å­—æ®µçš„æ•°æ®\\n- åˆ›å»ºç´¢å¼•å°†é™ä½æ•°æ®å†™å…¥æ•ˆç‡\\n  - å› ä¸ºæ•°æ®å˜åŠ¨æ—¶éœ€è¦åŒæ­¥æ›´æ–°ç´¢å¼•è¡¨\\n  - å†™å…¥æ“ä½œå¤šçš„è¡¨æ…åŠ ç´¢å¼•\\n\\n### é‡ç° `merge` ä¼˜åŒ–æ¡ˆä¾‹\\n\\nå°±æ•°æ®åº“çš„å¢åˆ æ”¹æŸ¥æ¥è¯´ï¼Œå¯èƒ½æˆ‘ä»¬å¹³æ—¶ç†Ÿæ‚‰çš„æ˜¯ `insert`ã€`delete`ã€`update` å’Œ `select`ï¼Œè€Œ `merge` æ˜¯ä¸€ä¸ªèšåˆæ“ä½œï¼Œå¯ä»¥åœ¨ä¸€æ¡è¯­å¥é‡Œé¢å®ç°å¢åˆ æ”¹æŸ¥ã€‚\\n\\nmerge çš„è¯­æ³•ç»“æ„è¡¨æ˜äº†å…¶é€‚ç”¨äºå‚ç…§ä¸€å¼ è¡¨çš„æ•°æ®æ¥æ“ä½œå¦ä¸€å¼ è¡¨çš„åœºåˆã€‚å…¶ä»–æ“ä½œæš‚ä¸”ä¸è®ºï¼Œå½“ä½¿ç”¨ merge æ¥æ›¿ä»£ update æ—¶ï¼Œç”±äºæ›´æ–°æœºåˆ¶çš„ä¸åŒï¼Œä¼¼ä¹ merge æ‹¥æœ‰å¤©ç„¶ä¼˜åŠ¿ï¼Œç»å¸¸èƒ½æ¯” update æ“ä½œè¦å¿«ã€‚\\n\\nä¸‹é¢çš„è¯­å¥å°†ç‰©å“è¡¨æ‰€æœ‰æ•°æ®çš„ `enable_flag` è®¾ç½®ä¸º `0`ï¼Œå³å¤±æ•ˆæ‰€æœ‰ç‰©å“ã€‚ç»è¿‡å¤šæ¬¡æ¸…é™¤ç¼“å­˜å†æ‰§è¡Œä¹‹åï¼Œåœ¨æˆ‘æœ¬åœ°ç¯å¢ƒä¸‹å¹³å‡æ°´å¹³åœ¨ 2 åˆ† 10 ç§’å·¦å³ã€‚\\n\\n```sql\\nSQL> update items set enable_flag = 0;\\n\\n5000000 rows updated.\\n\\nElapsed: 00:02:16.88\\n```\\n\\nä¸‹é¢åˆ™æ˜¯ä½¿ç”¨ merge æ¥è¿›è¡Œè¿™ä¸€æ“ä½œï¼ŒåŒæ ·çš„å¤šæ¬¡æ¸…é™¤ç¼“å­˜æ‰§è¡Œçš„ç»“æœï¼Œå¹³å‡æ°´å¹³åœ¨ 1 åˆ† 30 ç§’å·¦å³ã€‚\\n\\n```sql\\nSQL> merge into items i using dual\\non (1=1) when matched then\\nupdate set i.enable_flag = 0;\\n\\n5000000 rows merged.\\n\\nElapsed: 00:01:35.50\\n```\\n\\nå³ä½¿æ˜¯è¿™ä¹ˆç®€å•çš„ä»»åŠ¡ï¼Œmerge ä¾æ—§æ¯” update è¦å¿« 40 ç§’å·¦å³ï¼Œæå‡ 30% çš„æ•ˆç‡ã€‚\\n\\nä½†æ˜¯é€šè¿‡åˆ†æä¸¤è¾¹çš„æ‰§è¡Œè®¡åˆ’ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸‹é¢çš„ä¿¡æ¯ã€‚\\n\\n- `update` çš„ cost ä¸º 39,811ï¼›`merge` ä¸º 59,127\\n- `update` è®¿é—®å¹¶ä¿®æ”¹äº† 61M æ•°æ®ï¼›`merge` æœ€ç»ˆä¿®æ”¹äº† 61M æ•°æ®ï¼Œä½†æ˜¯ä¸­é€”è®¿é—®äº† 1,239M æ•°æ®\\n\\nmerge è™½ç„¶é€Ÿåº¦å¿«äº updateï¼Œä½†æ˜¯ç”±äºè®¿é—®æ•°æ®é‡è¿œè¶…è¿‡ updateï¼Œæ‰€ä»¥ä¼˜åŒ–å™¨åˆ¤å®šå…¶å¼€é”€å¤§äº updateã€‚\\n\\nç®€å•è¯´ï¼Œå°±æ˜¯è¿™ç§æƒ…å†µä¸‹ merge ä¼šä½¿ç”¨æ›´å¤šçš„å†…å­˜æ¥æå‡æ‰§è¡Œæ•ˆç‡ã€‚ä¸è¿‡ merge æœ¬èº«å¹¶ä¸æ˜¯è¢«è®¾è®¡æˆä¸»è¦ç”¨æ¥å¤„ç†è¿™ç§æƒ…å†µçš„ï¼Œæ¥çœ‹ä¸€ä¸ªå¤æ‚ç‚¹çš„ä¾‹å­ã€‚\\n\\né¦–å…ˆè¿˜æ˜¯è®¾è®¡ä¸€ä¸ªæ›´æ–°çš„éœ€æ±‚ã€‚\\n\\næ¢ç´¢æ•°æ®çš„æ—¶å€™æˆ‘ä»¬å‘ç°åŒä¸€ä¸ªç©å®¶ ID ä¸‹é¢ä¼šæœ‰é‡å¤çš„è§’è‰²ï¼Œè€Œä¸”é‡å¤è§’è‰²æœ‰æ¥è¿‘ 19 ä¸‡ä¹‹å¤šï¼æ‰€ä»¥æˆ‘ä»¬åšä¸€ä¸ªæ¶ä½œå‰§ï¼Œæ‰¾åˆ°å­˜åœ¨å¤šä¸ªè§’è‰²çš„ç©å®¶ï¼Œä¿ç•™ç­‰çº§æœ€é«˜çš„é‚£ä¸ªè§’è‰²ä¸åŠ¨ï¼Œå°†å…¶ä»–çš„è§’è‰²å¯¹åº”çš„æ‰€æœ‰çš„ç‰©å“æ•°é‡ï¼Œæ›´æ–°ä¸ºè¿™ä¸ªè§’è‰²çš„ç­‰çº§ï¼\\n\\n> è¿˜æ˜¯é‚£å¥è¯ï¼Œåˆ«æƒ³è¿™æœ‰ä»€ä¹ˆæ„ä¹‰ã€‚å°±å½“æ˜¯æ¥è‡ªä¸€ä¸ªé»‘å®¢çš„æ¶ä½œå‰§æŠŠ ğŸ‘¿ï¼\\n\\nåˆ†æä¸€ä¸‹è¿™ä¸ªéœ€æ±‚ï¼Œæˆ‘ä»¬éœ€è¦åšè¿™äº›äº‹æƒ…ã€‚\\n\\n- **éœ€æ±‚**ï¼š\\n  - å°†ç‰©å“æ•°é‡å­—æ®µæ›´æ–°ä¸ºç­‰çº§å­—æ®µçš„å€¼\\n  - æ›´æ–°æœ€åæ›´æ–°æ—¶é—´å­—æ®µçš„å€¼\\n- **æ¡ä»¶**ï¼š\\n  - ç©å®¶ ID ç›¸åŒ\\n  - æ‹¥æœ‰å¤šä¸ªè§’è‰²\\n  - é™¤äº†ç­‰çº§æœ€é«˜çš„è§’è‰²ä¹‹å¤–\\n  - æ‰€æœ‰ç‰©å“æ \\n\\n// æ–½å·¥ç°åœº\\n\\n```sql\\nupdate items i\\nset (item_num, last_update_time)\\n= (\\n  select\\n    t.character_level as item_num,\\n    current_timestamp as last_update_time\\n  from (\\n    select\\n      c.character_id,\\n      c.character_level,\\n      row_number() over(\\n        partition by c.gamer_id\\n        order by c.character_level desc\\n      ) as flag\\n    from\\n      characters c\\n    inner join\\n      (select gamer_id from characters\\n      group by gamer_id having count(1) > 1) t\\n    on t.gamer_id = c.gamer_id\\n  ) t\\n  where i.character_id = t.character_id\\n  and t.flag > 1 and rownum <= 100\\n)\\nwhere exists (\\n  select 1 from (\\n    select\\n      c.character_id,\\n      row_number() over(\\n        partition by c.gamer_id\\n        order by c.character_level desc\\n      ) as flag\\n    from\\n      characters c\\n    inner join\\n      (select gamer_id from characters\\n      group by gamer_id having count(1) > 1) t\\n    on t.gamer_id = c.gamer_id\\n  ) t where i.character_id = t.character_id\\n  and t.flag > 1 and rownum <= 100\\n);\\n\\n\\n\\n\\nselect count(1) from items i, (\\n    select\\n      c.character_id,\\n      c.character_level,\\n      row_number() over(\\n        partition by c.gamer_id\\n        order by c.character_level desc\\n      ) as flag\\n    from\\n      characters c\\n    inner join\\n      (select gamer_id from characters\\n      group by gamer_id having count(1) > 1) t\\n    on t.gamer_id = c.gamer_id\\n  ) t\\n  where i.character_id = t.character_id\\n  and t.flag > 1 and rownum <= 100;\\n\\nselect count(1) from\\nitems i,\\n(\\nselect\\n      c.character_id,\\n      row_number() over(\\n        partition by c.gamer_id\\n        order by c.character_level desc\\n      ) as flag\\n    from\\n      characters c\\n    inner join\\n      (select gamer_id from characters\\n      group by gamer_id having count(1) > 1) t\\n    on t.gamer_id = c.gamer_id and c.character_gender = 0\\n  ) t where i.character_id = t.character_id\\n  and t.flag > 1 and rownum <= 100\\n\\n\\nupdate items i set i.enable_flag = 0\\nfrom characters c where c.character_id < 10\\nand c.character_id = i.character_id;\\n\\n\\nselect count(1) from (\\n  select\\n    c.character_id,\\n    row_number() over(\\n      partition by c.gamer_id\\n      order by c.character_level desc\\n    ) as flag\\n  from\\n    characters c\\n  inner join\\n    (select gamer_id from characters\\n    group by gamer_id having count(1) > 1) t\\n  on t.gamer_id = c.gamer_id\\n) where flag > 1\\n;\\n```\\n\\n```sql\\nmerge into items i using (\\n  select\\n    rownum as rn,\\n    c.character_id,\\n    c.character_level,\\n    row_number() over(\\n      partition by c.gamer_id\\n      order by c.character_level desc\\n    ) as flag\\n  from\\n    characters c\\n  inner join\\n    (select gamer_id from characters\\n    group by gamer_id having count(1) > 1) g\\n  on g.gamer_id = c.gamer_id\\n) t\\non (i.character_id = t.character_id and t.flag > 1 and t.rn <= 100)\\nwhen matched then\\nupdate set i.item_num = t.character_level,\\n  last_update_time = current_timestamp;\\n```\\n\\n\\n\\n\\n```sql\\nupdate items i\\nset (item_num, last_update_time)\\n= (\\n  select\\n    t.character_level as item_num,\\n    current_timestamp as last_update_time\\n  from temp01 t\\n  where i.character_id = t.character_id\\n  and t.flag > 1 and rownum <= 100\\n)\\nwhere exists (\\n  select 1 from temp01 t where i.character_id = t.character_id\\n  and t.flag > 1 and rownum <= 100\\n);\\n```\\n\",\"frontmatter\":\"title: Oracle æ•°æ®åº“ SQL è°ƒä¼˜ç¬”è®° 2 - é‡ç°ä¸å®è·µ\\nsubtitle: ä½¿ç”¨ Docker å¿«é€Ÿæ­å»ºä¸€ä¸ª Oracle æ•°æ®åº“æµ‹è¯•ç¯å¢ƒï¼Œæ¥åšä¸€æ¬¡è°ƒä¼˜å®æˆ˜ï¼\\ndate: 2019-01-14 10:15:00 +8\\n# lastUpdateTime: 2019-01-08 17:57:00 +8\\ntags:\\n  - Oracle\\n  - SQL\\n  - Database\\n  - Docker\"}"],"sourceRoot":""}